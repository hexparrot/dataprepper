#!/bin/bash
#
# process_userdata_transformed
#
# Recursively find all .json files in userdata/transformed, apply transformations,
# and write the output to userdata/purposebuilt/<subdir> (mirroring subdirectories).
#
# Usage:
#   ./process_userdata_transformed [SUBDIR]
#   Where SUBDIR is a directory name under userdata/purposebuilt (default: "piped")

set -e  # Exit on first error

# 1) Decide on subdir name under "userdata/purposebuilt"
PURPOSE_SUBDIR="${1:-output}"

KEPT_AUTHORS="me,unspecified"
BASE_TRANSFORMED="userdata/transformed"
BASE_PURPOSEBUILT="userdata/purposebuilt/$PURPOSE_SUBDIR"

echo "=============================================================="
echo "Scanning $BASE_TRANSFORMED for JSON files..."
echo "Applying message transformations..."
echo "Output will go to: $BASE_PURPOSEBUILT"
echo "=============================================================="

# We'll use 'find' to locate all .json files recursively
find "$BASE_TRANSFORMED" -type f -name '*.json' -print0 | while IFS= read -r -d '' json_file; do
    
    # Compute relative path (strip off the BASE_TRANSFORMED prefix)
    rel_path="${json_file#$BASE_TRANSFORMED/}"

    # Build the output path under BASE_PURPOSEBUILT, preserving subdirectories
    output_file="$BASE_PURPOSEBUILT/$rel_path"

    # Ensure the output directory exists
    mkdir -p "$(dirname "$output_file")"

    echo "Processing: $json_file -> $output_file"

    # Apply transformations (the "pipes" chain)
    if cat "$json_file" \
        | ./pipes/rewrite_author_norm.py \
        | ./pipes/rewrite_author_merge.py "$KEPT_AUTHORS" user \
        | ./pipes/rewrite_newlines.py \
        > "$output_file"
    then
        echo " -> Done."
    else
        echo " -> Failed to process: $json_file"
        rm -f "$output_file"  # Remove partial output on failure
    fi

    echo "--------------------------------------------------------------"
done

echo "=============================================================="
echo "All applicable .json files have been processed."
echo "Results saved under: $BASE_PURPOSEBUILT"
echo "=============================================================="

